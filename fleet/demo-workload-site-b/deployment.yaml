apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-workload-site-b
  namespace: demo-workload-site-b
  labels:
    app: demo-workload-site-b
    site: site-b
spec:
  replicas: 0
  selector:
    matchLabels:
      app: demo-workload-site-b
  template:
    metadata:
      labels:
        app: demo-workload-site-b
        site: site-b
    spec:
      serviceAccountName: demo-workload-site-b
      # nodeAffinity removed: Kubernetes node hostnames don't match expected pattern
      # Nodes have hostnames like "m-<uuid>" instead of "node1-siteb", etc.
      # Workloads will be scheduled on any available node in the cluster
      # affinity:
      #   nodeAffinity:
      #     requiredDuringSchedulingIgnoredDuringExecution:
      #       nodeSelectorTerms:
      #       - matchExpressions:
      #         - key: kubernetes.io/hostname
      #           operator: In
      #           values:
      #           - node1-siteb
      #           - node2-siteb
      #           - node3-siteb
      #           - node4-siteb
      #           - node5-siteb
      initContainers:
      - name: inject-node-info
        image: curlimages/curl:8.4.0
        command:
        - sh
        - -c
        - |
          # Get node name and pod IP from environment
          NODE_NAME=${NODE_NAME}
          POD_IP=${POD_IP}
          POD_NAMESPACE=${POD_NAMESPACE}
          
          # Get node IP and site-id from Kubernetes API
          TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
          
          # Get node information
          NODE_INFO=$(curl -s -k -H "Authorization: Bearer $TOKEN" \
            "https://kubernetes.default.svc/api/v1/nodes/${NODE_NAME}")
          
          # Extract node IP and cluster name
          if command -v jq >/dev/null 2>&1; then
            NODE_IP=$(echo "$NODE_INFO" | jq -r '.status.addresses[] | select(.type=="InternalIP") | .address' 2>/dev/null || echo "unknown")
            SITE_ID=$(echo "$NODE_INFO" | jq -r '.metadata.labels["site-id"] // "site-b"' 2>/dev/null || echo "site-b")
            CLUSTER_NAME=$(echo "$NODE_INFO" | jq -r '.metadata.labels["cattle.io/cluster-name"] // .metadata.labels["cluster.x-k8s.io/cluster-name"] // "unknown"' 2>/dev/null || echo "unknown")
          else
            # Fallback: use grep and sed
            NODE_IP=$(echo "$NODE_INFO" | grep -o '"addresses":\[{[^}]*"type":"InternalIP"[^}]*"address":"[^"]*"' \
              | grep -o '"address":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
            SITE_ID=$(echo "$NODE_INFO" | grep -o '"site-id":"[^"]*"' | cut -d'"' -f4 || echo "site-b")
            CLUSTER_NAME=$(echo "$NODE_INFO" | grep -o '"cattle.io/cluster-name":"[^"]*"' | head -1 | cut -d'"' -f4)
            if [ -z "$CLUSTER_NAME" ]; then
              CLUSTER_NAME=$(echo "$NODE_INFO" | grep -o '"cluster.x-k8s.io/cluster-name":"[^"]*"' | head -1 | cut -d'"' -f4)
            fi
          fi
          
          # Final fallback for node IP
          if [ "$NODE_IP" = "unknown" ] || [ -z "$NODE_IP" ]; then
            NODE_IP=$(getent hosts ${NODE_NAME} 2>/dev/null | awk '{print $1}' | head -1 || echo "${NODE_NAME}")
          fi
          
          # Ensure site-id is set (default to site-b for this workload)
          if [ -z "$SITE_ID" ] || [ "$SITE_ID" = "null" ]; then
            SITE_ID="site-b"
          fi

          if [ -z "$CLUSTER_NAME" ] || [ "$CLUSTER_NAME" = "null" ]; then
            CLUSTER_NAME="unknown"
          fi

          # Get pod distribution for this workload
          PODS_INFO=$(curl -s -k -H "Authorization: Bearer $TOKEN" \
            "https://kubernetes.default.svc/api/v1/namespaces/${POD_NAMESPACE}/pods?labelSelector=app%3Ddemo-workload-site-b")
          if command -v jq >/dev/null 2>&1; then
            POD_COUNT=$(echo "$PODS_INFO" | jq -r '.items | length' 2>/dev/null || echo "0")
            REPLICA_NODES=$(echo "$PODS_INFO" | jq -r '.items[].spec.nodeName' 2>/dev/null | sort -u | wc -l | tr -d ' ')
          else
            POD_NODES=$(echo "$PODS_INFO" | grep -o '"nodeName":"[^"]*"' | cut -d'"' -f4)
            if [ -n "$POD_NODES" ]; then
              POD_COUNT=$(echo "$POD_NODES" | wc -l | tr -d ' ')
              REPLICA_NODES=$(echo "$POD_NODES" | sort -u | wc -l | tr -d ' ')
            else
              POD_COUNT="unknown"
              REPLICA_NODES="unknown"
            fi
          fi
          
          # Debug output
          echo "DEBUG: NODE_NAME=${NODE_NAME}"
          echo "DEBUG: NODE_IP=${NODE_IP}"
          echo "DEBUG: POD_IP=${POD_IP}"
          echo "DEBUG: SITE_ID=${SITE_ID}"
          echo "DEBUG: CLUSTER_NAME=${CLUSTER_NAME}"
          echo "DEBUG: POD_COUNT=${POD_COUNT}"
          echo "DEBUG: REPLICA_NODES=${REPLICA_NODES}"
          
          # Replace placeholders in template
          sed -e "s|{{NODE_IP}}|$NODE_IP|g" \
              -e "s|{{NODE_NAME}}|$NODE_NAME|g" \
              -e "s|{{POD_IP}}|$POD_IP|g" \
              -e "s|{{SITE_ID}}|$SITE_ID|g" \
              -e "s|{{CLUSTER_NAME}}|$CLUSTER_NAME|g" \
              -e "s|{{POD_COUNT}}|$POD_COUNT|g" \
              -e "s|{{REPLICA_NODES}}|$REPLICA_NODES|g" \
              /templates/index.html.template > /output/index.html
          
          # Verify replacement worked
          if grep -q "{{NODE_IP}}" /output/index.html; then
            echo "WARNING: NODE_IP placeholder not replaced!"
            sed -i "s|{{NODE_IP}}|$NODE_IP|g" /output/index.html
          fi
          
          echo "Verification: NODE_IP in HTML: $(grep -o '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}' /output/index.html | head -1)"
        volumeMounts:
        - name: templates
          mountPath: /templates
        - name: output
          mountPath: /output
        - name: service-account
          mountPath: /var/run/secrets/kubernetes.io/serviceaccount
          readOnly: true
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
      containers:
      - name: web
        image: nginx:1.25-alpine
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        volumeMounts:
        - name: output
          mountPath: /usr/share/nginx/html
          readOnly: true
        - name: nginx-config
          mountPath: /etc/nginx/conf.d
          readOnly: true
      volumes:
      - name: templates
        configMap:
          name: demo-workload-site-b-config
          items:
          - key: index.html.template
            path: index.html.template
      - name: output
        emptyDir: {}
      - name: nginx-config
        configMap:
          name: demo-workload-site-b-config
          items:
          - key: nginx.conf
            path: default.conf
      - name: service-account
        projected:
          sources:
          - serviceAccountToken:
              expirationSeconds: 3600
              path: token
          - downwardAPI:
              items:
              - path: namespace
                fieldRef:
                  fieldPath: metadata.namespace


