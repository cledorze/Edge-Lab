apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    fleet.cattle.io/redeploy: "true"
  name: update-ingress-hostname
  namespace: demo-workload-site-b
  annotations:
    # This job runs once to update the Ingress with the correct Ingress Controller IP
    # Automatically detects Traefik LoadBalancer, nginx LoadBalancer, or falls back to node IP
    # Based on SUSE Edge 3.4 documentation recommendation (Section 24.6.1: "Ingress with MetalLB")
    # Reference: https://documentation.suse.com/suse-edge/3.4/html/edge/kubernetes-metallb.html#_ingress_with_metallb
spec:
  # ttlSecondsAfterFinished removed: Fleet requires Jobs to persist to show as "Ready"
  # The Job will remain after completion so Fleet can track it properly
  backoffLimit: 3  # Allow 3 retries for transient failures (network, DNS, etc.)
  template:
    metadata:
  annotations:
    fleet.cattle.io/redeploy: "true"
      labels:
        app: update-ingress-hostname
    spec:
      restartPolicy: OnFailure
      serviceAccountName: demo-workload-site-b
      containers:
      - name: update-ingress
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - /scripts/update-ingress-hostname.sh
        env:
        - name: INGRESS_NAME
          value: demo-workload-site-b
        - name: NAMESPACE
          value: demo-workload-site-b
        - name: HOSTNAME_PREFIX
          value: demo-workload-site-b
        volumeMounts:
        - name: scripts
          mountPath: /scripts
          readOnly: true
      volumes:
      - name: scripts
        configMap:
          name: update-ingress-scripts
          defaultMode: 0755
